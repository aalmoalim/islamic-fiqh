<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mas'h al-Khuffayn Tracker - Fiqh of Purification</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 22px;
        }

        .condition-item {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
        }

        .condition-item:hover {
            transform: translateX(5px);
        }

        .condition-item label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
        }

        .condition-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .status-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .status-qualified {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status-not-qualified {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .timer-section {
            text-align: center;
            padding: 20px;
        }

        .timer-display {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .timer-label {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .expired {
            color: #dc3545;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group select,
        .form-group input[type="datetime-local"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input[type="datetime-local"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 14px;
            color: #0d47a1;
        }

        .hidden {
            display: none;
        }

        .conditions-list {
            list-style: none;
            padding: 0;
        }

        .conditions-list li {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .distance-result {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }

        .distance-traveler {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .distance-resident {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #17a2b8;
        }

        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #ddd;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            margin-bottom: 10px;
        }

        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-small {
            width: auto;
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 0;
        }

        .loading {
            text-align: center;
            padding: 10px;
            color: #667eea;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üïå Mas'h al-Khuffayn Tracker</h1>
            <p>Wiping on Socks - Fiqh of Purification</p>
        </div>

        <div class="content">
            <!-- Qualification Check Section -->
            <div class="section">
                <h2>1. Check Qualification</h2>
                <p style="margin-bottom: 15px; color: #666;">Verify all 4 conditions are met:</p>
                
                <div class="condition-item">
                    <input type="checkbox" id="condition1" onchange="checkQualification()">
                    <label for="condition1">Socks are clean (ÿ∑ÿßŸáÿ±) - Not contaminated with impurity (urine, blood, feces, alcohol, etc.) and not made from untanned dead animal hide</label>
                </div>

                <div class="condition-item">
                    <input type="checkbox" id="condition2" onchange="checkQualification()">
                    <label for="condition2">Put on after complete purity - Wudu' was completed before putting on socks</label>
                </div>

                <div class="condition-item">
                    <input type="checkbox" id="condition3" onchange="checkQualification()">
                    <label for="condition3">Covering required area - Socks cover from toes to ankles</label>
                </div>

                <div class="condition-item">
                    <input type="checkbox" id="condition4" onchange="checkQualification()">
                    <label for="condition4">Strong & durable - Socks prevent water penetration and allow normal walking</label>
                </div>

                <div id="qualificationStatus" class="status-box hidden"></div>
            </div>

            <!-- Distance Calculator Section -->
            <div class="section">
                <h2>2. Calculate Travel Distance</h2>
                <p style="margin-bottom: 15px; color: #666;">Enter your origin and destination to determine if you're a traveler (‚â•83km) or resident (<83km):</p>
                
                <div class="form-group">
                    <label for="origin">Origin (Starting Point):</label>
                    <input type="text" id="origin" placeholder="e.g., Tbilisi, Georgia or address">
                    <button class="btn btn-small" onclick="useCurrentLocation('origin')">üìç Use Current Location</button>
                </div>

                <div class="form-group">
                    <label for="destination">Destination:</label>
                    <input type="text" id="destination" placeholder="e.g., Batumi, Georgia or address">
                </div>

                <button class="btn" onclick="calculateDistance()">üîç Calculate Distance</button>
                <div id="distanceLoading" class="loading hidden"></div>
                <div id="distanceResult" class="distance-result hidden"></div>
                <div id="map" class="hidden"></div>
            </div>

            <!-- Timer Setup Section -->
            <div class="section">
                <h2>3. Track Duration</h2>
                
                <div class="form-group">
                    <label for="status">Your Status:</label>
                    <select id="status" onchange="updateDuration()">
                        <option value="resident">Resident (ŸÖŸÇŸäŸÖ) - 1 Day & Night (24 hours)</option>
                        <option value="traveler">Traveler (ŸÖÿ≥ÿßŸÅÿ±) - 3 Days & Nights (72 hours)</option>
                        <option value="short-travel">Short Travel (< 83km) - 1 Day & Night</option>
                        <option value="sinful-travel">Disobedient in Travel - 1 Day & Night</option>
                    </select>
                    <div class="help-text">Status is automatically set based on distance calculation above</div>
                </div>

                <div class="form-group">
                    <label for="hadathTime">When did your hadath end? (End of impurity)</label>
                    <input type="datetime-local" id="hadathTime">
                    <div class="help-text">This is when your wudu' was broken and you need to renew it. The duration starts from this time.</div>
                </div>

                <button class="btn" onclick="startTracking()">Start Tracking Duration</button>
                <button class="btn btn-secondary" onclick="resetTracker()">Reset Tracker</button>
            </div>

            <!-- Timer Display Section -->
            <div class="section hidden" id="timerSection">
                <h2>4. Remaining Time</h2>
                <div class="timer-section">
                    <div class="timer-display" id="timerDisplay">00:00:00</div>
                    <div class="timer-label" id="timerLabel"></div>
                    <div class="info-box" id="timerInfo"></div>
                </div>
            </div>

            <!-- Information Section -->
            <div class="section">
                <h2>üìö Important Notes</h2>
                <ul class="conditions-list">
                    <li><strong>Distance Calculator:</strong> Uses straight-line distance. Threshold is 83km (equivalent to 2 days' journey by foot). Road distance may vary slightly.</li>
                    <li><strong>Duration starts</strong> from when hadath ended (established view), not from when you put on socks.</li>
                    <li><strong>Wiping is only for wudu'</strong> - NOT for ghusl or removing najasah.</li>
                    <li><strong>Washing feet is better</strong> than wiping (original act).</li>
                    <li><strong>Invalidators:</strong> Removing socks, duration expires, major impurity occurs (janabah, menses, etc.).</li>
                    <li><strong>If duration expires or socks removed:</strong> Only wash feet (no need to repeat entire wudu' if still pure).</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let trackingInterval = null;
        const STORAGE_KEY = 'socksWipingTracker';
        let map = null;
        let originMarker = null;
        let destMarker = null;
        const TRAVELER_THRESHOLD_KM = 83; // 83 km = 2 days journey by foot

        // Load saved data on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
        });

        // Haversine formula to calculate distance between two coordinates
        function calculateDistanceBetweenCoords(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in kilometers
        }

        // Geocode address using Nominatim (OpenStreetMap)
        async function geocodeAddress(address) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,
                    {
                        headers: {
                            'User-Agent': 'Mas-h-Khuffayn-Tracker/1.0'
                        }
                    }
                );
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        displayName: data[0].display_name
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Use current location (browser geolocation)
        function useCurrentLocation(type) {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }

            const inputField = type === 'origin' ? document.getElementById('origin') : document.getElementById('destination');
            inputField.value = 'Getting location...';
            inputField.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Reverse geocode to get address
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`,
                            {
                                headers: {
                                    'User-Agent': 'Mas-h-Khuffayn-Tracker/1.0'
                                }
                            }
                        );
                        const data = await response.json();
                        inputField.value = data.display_name || `${lat}, ${lon}`;
                    } catch (error) {
                        inputField.value = `${lat}, ${lon}`;
                    }
                    inputField.disabled = false;
                },
                function(error) {
                    alert('Error getting location: ' + error.message);
                    inputField.value = '';
                    inputField.disabled = false;
                }
            );
        }

        // Calculate distance between origin and destination
        async function calculateDistance() {
            const originInput = document.getElementById('origin').value.trim();
            const destInput = document.getElementById('destination').value.trim();

            if (!originInput || !destInput) {
                alert('Please enter both origin and destination.');
                return;
            }

            const loadingDiv = document.getElementById('distanceLoading');
            const resultDiv = document.getElementById('distanceResult');
            const mapDiv = document.getElementById('map');

            // Show loading
            loadingDiv.classList.remove('hidden');
            loadingDiv.textContent = 'üîç Looking up locations...';
            resultDiv.classList.add('hidden');
            mapDiv.classList.add('hidden');

            try {
                // Geocode both addresses
                const [originData, destData] = await Promise.all([
                    geocodeAddress(originInput),
                    geocodeAddress(destInput)
                ]);

                if (!originData) {
                    throw new Error('Could not find origin location. Please be more specific.');
                }
                if (!destData) {
                    throw new Error('Could not find destination location. Please be more specific.');
                }

                // Calculate distance
                const distanceKm = calculateDistanceBetweenCoords(
                    originData.lat, originData.lon,
                    destData.lat, destData.lon
                );

                // Display result
                loadingDiv.classList.add('hidden');
                resultDiv.classList.remove('hidden');

                const isTraveler = distanceKm >= TRAVELER_THRESHOLD_KM;
                resultDiv.className = `distance-result ${isTraveler ? 'distance-traveler' : 'distance-resident'}`;
                
                resultDiv.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">
                        üìç Distance: <strong>${distanceKm.toFixed(2)} km</strong>
                    </div>
                    <div style="font-size: 18px;">
                        ${isTraveler ? '‚úÖ Traveler (ŸÖÿ≥ÿßŸÅÿ±)' : 'üè† Resident/Short Travel (ŸÖŸÇŸäŸÖ)'}
                    </div>
                    <div style="font-size: 14px; margin-top: 10px; opacity: 0.8;">
                        ${isTraveler ? 'Duration: 3 Days & Nights (72 hours)' : 'Duration: 1 Day & Night (24 hours)'}
                    </div>
                    <div style="font-size: 12px; margin-top: 10px; font-style: italic;">
                        * This is straight-line distance. Actual road distance may vary.
                    </div>
                `;

                // Update status dropdown automatically
                const statusSelect = document.getElementById('status');
                if (isTraveler) {
                    statusSelect.value = 'traveler';
                } else {
                    statusSelect.value = 'short-travel';
                }

                // Display map
                displayMap(originData, destData, distanceKm);

            } catch (error) {
                loadingDiv.classList.add('hidden');
                alert(error.message || 'Error calculating distance. Please try again.');
            }
        }

        // Display map with markers and route
        function displayMap(origin, destination, distance) {
            const mapDiv = document.getElementById('map');
            mapDiv.classList.remove('hidden');

            // Remove existing map if any
            if (map) {
                map.remove();
            }

            // Calculate center point
            const centerLat = (origin.lat + destination.lat) / 2;
            const centerLon = (origin.lon + destination.lon) / 2;

            // Create map
            map = L.map('map').setView([centerLat, centerLon], distance > 100 ? 6 : 8);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Add markers
            originMarker = L.marker([origin.lat, origin.lon])
                .addTo(map)
                .bindPopup(`<b>Origin</b><br>${origin.displayName}`)
                .openPopup();

            destMarker = L.marker([destination.lat, destination.lon])
                .addTo(map)
                .bindPopup(`<b>Destination</b><br>${destination.displayName}<br><b>Distance: ${distance.toFixed(2)} km</b>`);

            // Draw line between points
            L.polyline(
                [[origin.lat, origin.lon], [destination.lat, destination.lon]],
                {color: '#667eea', weight: 3, opacity: 0.7}
            ).addTo(map);

            // Fit map to show both markers
            const group = new L.featureGroup([originMarker, destMarker]);
            map.fitBounds(group.getBounds().pad(0.2));
        }

        function checkQualification() {
            const conditions = [
                document.getElementById('condition1').checked,
                document.getElementById('condition2').checked,
                document.getElementById('condition3').checked,
                document.getElementById('condition4').checked
            ];

            const allChecked = conditions.every(condition => condition === true);
            const statusBox = document.getElementById('qualificationStatus');
            
            statusBox.classList.remove('hidden');
            
            if (allChecked) {
                statusBox.className = 'status-box status-qualified';
                statusBox.textContent = '‚úÖ Qualified to wipe on socks!';
            } else {
                const checkedCount = conditions.filter(c => c).length;
                statusBox.className = 'status-box status-not-qualified';
                statusBox.textContent = `‚ùå Not qualified yet (${checkedCount}/4 conditions met)`;
            }
        }

        function updateDuration() {
            // This can be used to update UI based on status if needed
        }

        function startTracking() {
            const hadathTime = document.getElementById('hadathTime').value;
            const status = document.getElementById('status').value;

            if (!hadathTime) {
                alert('Please select when your hadath ended.');
                return;
            }

            // Calculate duration in hours based on status
            let durationHours = 24; // Default for resident
            if (status === 'traveler') {
                durationHours = 72; // 3 days for traveler
            }

            const trackingData = {
                hadathTime: hadathTime,
                status: status,
                durationHours: durationHours
            };

            // Save to localStorage
            localStorage.setItem(STORAGE_KEY, JSON.stringify(trackingData));

            // Start timer
            startTimer();
        }

        function startTimer() {
            const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (!savedData) return;

            // Clear any existing interval
            if (trackingInterval) {
                clearInterval(trackingInterval);
            }

            // Show timer section
            document.getElementById('timerSection').classList.remove('hidden');

            // Update timer immediately and then every second
            updateTimer();
            trackingInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (!savedData) return;

            const hadathEndTime = new Date(savedData.hadathTime);
            const now = new Date();
            const durationMs = savedData.durationHours * 60 * 60 * 1000;
            const endTime = new Date(hadathEndTime.getTime() + durationMs);
            const remainingMs = endTime.getTime() - now.getTime();

            const timerDisplay = document.getElementById('timerDisplay');
            const timerLabel = document.getElementById('timerLabel');
            const timerInfo = document.getElementById('timerInfo');

            if (remainingMs <= 0) {
                // Duration expired
                timerDisplay.textContent = '00:00:00';
                timerDisplay.className = 'timer-display expired';
                timerLabel.textContent = '‚è∞ Duration has expired';
                timerInfo.textContent = 'You must remove socks and wash your feet. If you are still pure (only minor hadath), you only need to wash your feet - no need to repeat entire wudu\'.';
                clearInterval(trackingInterval);
            } else {
                // Calculate remaining time
                const hours = Math.floor(remainingMs / (1000 * 60 * 60));
                const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);

                timerDisplay.textContent = 
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');
                
                timerDisplay.className = 'timer-display';

                const statusText = savedData.status === 'traveler' 
                    ? 'Traveler (3 days)' 
                    : 'Resident (1 day)';
                
                timerLabel.textContent = `Status: ${statusText} | Started: ${new Date(savedData.hadathTime).toLocaleString()}`;
                
                const hoursRemaining = Math.floor(remainingMs / (1000 * 60 * 60));
                const minutesRemaining = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                
                if (hoursRemaining < 1) {
                    timerInfo.textContent = `‚ö†Ô∏è Less than 1 hour remaining! Time will expire at ${endTime.toLocaleString()}`;
                    timerInfo.style.background = '#fff3cd';
                    timerInfo.style.borderColor = '#ffc107';
                    timerInfo.style.color = '#856404';
                } else {
                    timerInfo.textContent = `Time expires at: ${endTime.toLocaleString()}`;
                    timerInfo.style.background = '#e7f3ff';
                    timerInfo.style.borderColor = '#2196F3';
                    timerInfo.style.color = '#0d47a1';
                }
            }
        }

        function resetTracker() {
            if (confirm('Are you sure you want to reset the tracker? This will clear all saved data.')) {
                localStorage.removeItem(STORAGE_KEY);
                document.getElementById('timerSection').classList.add('hidden');
                document.getElementById('hadathTime').value = '';
                document.getElementById('status').value = 'resident';
                
                // Uncheck all conditions
                ['condition1', 'condition2', 'condition3', 'condition4'].forEach(id => {
                    document.getElementById(id).checked = false;
                });
                document.getElementById('qualificationStatus').classList.add('hidden');
                
                if (trackingInterval) {
                    clearInterval(trackingInterval);
                    trackingInterval = null;
                }
            }
        }

        function loadSavedData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('hadathTime').value = data.hadathTime;
                document.getElementById('status').value = data.status;
                startTimer();
            }
        }
    </script>
</body>
</html>

